---
title: RabbitMQ TLS
date: 2022-01-24 17:52:40
tags:
  - TLS
  - Rabbitmq
  - Config
categories:
  - Configuration
cover: https://images.unsplash.com/photo-1642901797689-0201e23dbc1f?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1974&q=80
feature: true
---



## RabbitMQ TLS 

### Certification

[RabbitMQ TLS Support](https://www.rabbitmq.com/ssl.html#automated-certificate-generation)

Generate certificates with [TLS-GEN](https://github.com/michaelklishin/tls-gen)

```shell
ubuntu@data-layer-bastion-2:~/tck/cert/tls-gen/basic/result$ ll
total 44
drwxrwxr-x 2 ubuntu ubuntu 4096 Dec 14 06:30 ./
drwxrwxr-x 7 ubuntu ubuntu 4096 Dec 10 05:39 ../
-rw-rw-r-- 1 ubuntu ubuntu 1208 Dec 10 05:39 ca_certificate.pem
-rw------- 1 ubuntu ubuntu 1854 Dec 10 05:39 ca_key.pem
-rw-rw-r-- 1 ubuntu ubuntu 1204 Dec 10 05:39 client_certificate.pem
-rw------- 1 ubuntu ubuntu 2453 Dec 10 05:39 client_key.p12
-rw------- 1 ubuntu ubuntu 1874 Dec 10 05:39 client_key.pem
-rw-rw-r-- 1 ubuntu ubuntu  979 Dec 10 05:45 rabbitstore
-rw-rw-r-- 1 ubuntu ubuntu 1294 Dec 10 05:39 server_certificate.pem
-rw------- 1 ubuntu ubuntu 2517 Dec 10 05:39 server_key.p12
-rw------- 1 ubuntu ubuntu 1874 Dec 10 05:39 server_key.pem
```

### Server

#### Swarm 

```yaml
version: '3.2'
services:
  rabbitmqtls:
    image: rabbitmq:3.9-management
    volumes:
      - ./certs/ca_certificate.pem:/etc/rabbitmq/ca_certificate.pem
      - ./certs/server_certificate.pem:/etc/rabbitmq/server_certificate.pem
      - ./certs/server_key.pem:/etc/rabbitmq/server_key.pem
      - ./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
    ports:
      - "5672:5672"
      - "15672:15672"
      - "5671:5671"
    deploy:
      placement:
        constraints: [node.role == manager]
      restart_policy:
        condition: on-failure
```

rabbitmq.conf

```
loopback_users.guest = false
listeners.tcp.default = 5672
default_pass = rabbitpwd
default_user = rabbitmq
management.tcp.port = 15672
listeners.ssl.default = 0.0.0.0:5671

log.file.level = debug

ssl_options.password=stardust
ssl_options.versions.1=tlsv1.2
ssl_options.versions.2=tlsv1.1
ssl_options.cacertfile = /etc/rabbitmq/ca_certificate.pem
ssl_options.certfile   = /etc/rabbitmq/server_certificate.pem
ssl_options.keyfile    = /etc/rabbitmq/server_key.pem
ssl_options.verify     = verify_peer
ssl_options.fail_if_no_peer_cert = true
```

For mutual verification, set ssl_options.fail_if_no_peer_cert = true . On client side , it needs to provide PKCS12 format keystore and JSK format truststore.

#### Helm 

value.yaml

modify TLS section:

```yaml
tls:
    enabled: true
    autoGenerated: false
    failIfNoPeerCert: true 
    sslOptionsVerify: verify_peer
    caCertificate: |-
        -----BEGIN CERTIFICATE-----
        MIIDUDCCAjigAwIBAgIUbpNnPmvHXxBulcqi5tdYZmCwv6kwDQYJKoZIhvcNAQEL
        BQAwMTEgMB4GA1UEAwwXVExTR2VuU2VsZlNpZ25lZHRSb290Q0ExDTALBgNVBAcM
        BCQkJCQwHhcNMjExMjEwMDUzOTUzWhcNMzExMjA4MDUzOTUzWjAxMSAwHgYDVQQD
        DBdUTFNHZW5TZWxmU2lnbmVkdFJvb3RDQTENMAsGA1UEBwwEJCQkJDCCASIwDQYJ
        KoZIhvcNAQEBBQADggEPADCCAQoCggEBALBAyCgZXJCMZPpKu8XEFyqrleex2Tc0
        M1KayRT/JQDMe5UU7csmJ4BVBiTm7x/+xGfUdOsa+GXpqlRhYFy/a++iD+/5Iv8a
        6UrXWb3Ost2w1+7k02lIF5iLOJCjriy8D0As3BixC1twWRyaos5vAiv84owzSaCt
        LrgKQkNVAd9TqCG0GWq0JAx2yI+8auxdqT9JMqElYALUpYJHtsD2d7AY4iCXayk3
        1xsCYi5+RXTLjBAtb11aPFYxDHEUIc01OPW+7sMUWgVDWZC+39LN+AItuuBnXI9B
        SilVessAhLNvJBr5OIR4L6mTRRvmwz+unNYjcAIpu6E5fz3ouW4X6oMCAwEAAaNg
        MF4wCwYDVR0PBAQDAgEGMB0GA1UdDgQWBBSLId7LglANzKItcLLkcF6OWI/XSTAf
        BgNVHSMEGDAWgBSLId7LglANzKItcLLkcF6OWI/XSTAPBgNVHRMBAf8EBTADAQH/
        MA0GCSqGSIb3DQEBCwUAA4IBAQALy6BOdzwZtyy5w9ExVHeyYi0p1IGOO7j5RkbK
        pWwGzHMbI5a8lmlEk8Vo77u7iK6ppfzUOiYK9IqKqMjvhgRe7wUkvcT9rfHk9acc
        OPwYTOqGr2EoPvVESVU7q+BvVlLZE24dlEhji9c3BeNnqybAU/M4lMovBYbbUXZo
        3MtF9V4YGpgNsOHwlrG3QDYGHoMpLUR8WJ9uF2DQ2bRBmVXi8eeTiIIL6B1Xn5QT
        0amNKLKjlmebEEG9UzmZP6wekJdSZZ6XMWdCMup04tgDJCVXHZe5d6V0chvYwtcW
        R1VlTl6mD8yB9RZMVWONejzOdGDHW7dDchq4JZ7xfZ/jGiyL
        -----END CERTIFICATE-----
    serverCertificate: |- 
        -----BEGIN CERTIFICATE-----
        MIIDjzCCAnegAwIBAgIBATANBgkqhkiG9w0BAQsFADAxMSAwHgYDVQQDDBdUTFNH
        ZW5TZWxmU2lnbmVkdFJvb3RDQTENMAsGA1UEBwwEJCQkJDAeFw0yMTEyMTAwNTM5
        NTNaFw0zMTEyMDgwNTM5NTNaMDAxHTAbBgNVBAMMFGRhdGEtbGF5ZXItYmFzdGlv
        bi0yMQ8wDQYDVQQKDAZzZXJ2ZXIwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEK
        AoIBAQD2WmtH/In7A6zY1aa+wGRmVFh2aHl4dqSfF2qwzNTpaopdzCY1/0VJ7sj7
        3R2SAMuOkVkf9+KG8PLiiui80xL9dd0HPH8X3LZApSMilZhkJKF4MgxgzOHvk7IR
        5LXjwO5EyPxgt2dDwh7Q3YgT0DrYmIQe7+cfqCwcbyYhBQ2v9VYN2AErsqY3L4DG
        mdmfYgoH00E3WzyZr6SjqlvCyFZcaD1mOjfCybNepn99rVKCVQx15soEJGwEEbS9
        Zx5IezEXERIj5Mi03Xxa2SAx+DNNU2kDm82GWEEElVUFzUE1ultPjIB4TgX+sRg+
        tsbBIpJFo8kcWT5n5vvnbq7CvcmrAgMBAAGjgbIwga8wCQYDVR0TBAIwADALBgNV
        HQ8EBAMCBaAwEwYDVR0lBAwwCgYIKwYBBQUHAwEwQAYDVR0RBDkwN4IUZGF0YS1s
        YXllci1iYXN0aW9uLTKCFGRhdGEtbGF5ZXItYmFzdGlvbi0ygglsb2NhbGhvc3Qw
        HQYDVR0OBBYEFLhNTZUuZr4bjM4nS1ELSa45CAHfMB8GA1UdIwQYMBaAFIsh3suC
        UA3Moi1wsuRwXo5Yj9dJMA0GCSqGSIb3DQEBCwUAA4IBAQAYMymnd0pspaxs/MBm
        peeaWyfwEkJ0ZHY1QqPvVykqpv06FOMzORjf5AU0hgPHz+ylr4DlU/XaNtKQaoCg
        pW5b7vC1Sop9AnCgz5s6lPQHLPfsOGhtsL88cOKAL+9Lm+1C8+Mji//mRfnfT0MG
        CuCDVNqe3s0zEL/pQTXhNWI7QoaSKMdMY4Cn2HyadFUvAoao7onHiNLeWiTczrvT
        hWZX2S7VHYkKnf3Mfqxx5hyyGgq0xSJw9g+b14z0DL0N185vN+gTi3CtSttP1lMQ
        egTmwyNiNsj31Pbrf8iAjh4TmDgp52VpCM2NjsunsDl+2FSA7kS+XVyhKQv0NfA7
        esXO
        -----END CERTIFICATE-----
    serverKey: |-
        -----BEGIN ENCRYPTED PRIVATE KEY-----
        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
        -----END ENCRYPTED PRIVATE KEY-----
    existingSecret: ""
    existingSecretFullChain: false
```

configuration

```yaml
configuration: |-
  {{- if not .Values.loadDefinition.enabled -}}
  ## Username and password
  ##
  default_user = {{ .Values.auth.username }}
  default_pass = guest
  {{- end }}
  
  {{- if .Values.clustering.enabled }}
  ## Clustering
  ##
  cluster_formation.peer_discovery_backend  = rabbit_peer_discovery_k8s
  cluster_formation.k8s.host = kubernetes.default.svc.{{ .Values.clusterDomain }}
  cluster_formation.node_cleanup.interval = 10
  cluster_formation.node_cleanup.only_log_warning = true
  cluster_partition_handling = {{ .Values.clustering.partitionHandling }}
  {{- end }}
  # queue master locator
  queue_master_locator = min-masters
  # enable guest user
  loopback_users.guest = none
  {{ tpl .Values.extraConfiguration . }}
  {{- if .Values.auth.tls.enabled }}
  # ??????
  ssl_options.versions.1=tlsv1.2
  ssl_options.versions.2=tlsv1.1
  
  ssl_options.verify = {{ .Values.auth.tls.sslOptionsVerify }}
  listeners.ssl.default = {{ .Values.service.tlsPort }}
  ssl_options.password = stardust
  ssl_options.fail_if_no_peer_cert = {{ .Values.auth.tls.failIfNoPeerCert }}
  ssl_options.cacertfile = opt/bitnami/rabbitmq/certs/ca_certificate.pem
  ssl_options.certfile = opt/bitnami/rabbitmq/certs/server_certificate.pem
  ssl_options.keyfile = opt/bitnami/rabbitmq/certs/server_key.pem
  
  {{- end }}
  {{- if .Values.ldap.enabled }}
  auth_backends.1 = rabbit_auth_backend_ldap
  auth_backends.2 = internal
  {{- range $index, $server := .Values.ldap.servers }}
  auth_ldap.servers.{{ add $index 1 }} = {{ $server }}
  {{- end }}
  auth_ldap.port = {{ .Values.ldap.port }}
  auth_ldap.user_dn_pattern = {{ .Values.ldap.user_dn_pattern  }}
  {{- if .Values.ldap.tls.enabled }}
  auth_ldap.use_ssl = true
  {{- end }}
  {{- end }}
  {{- if .Values.metrics.enabled }}
  ## Prometheus metrics
  ##
  prometheus.tcp.port = 9419
  {{- end }}
  {{- if .Values.memoryHighWatermark.enabled }}
  ## Memory Threshold
  ##
  total_memory_available_override_value = {{ include "rabbitmq.toBytes" .Values.resources.limits.memory }}
  vm_memory_high_watermark.{{ .Values.memoryHighWatermark.type }} = {{ .Values.memoryHighWatermark.value }}
  {{- end }}
```

### TSL Proxy Termination  - Nginx

swarm config 

```yaml
version: '3.2'
services:
  nginx:
    image: nginx:latest
    ports:
      - "80:80"
      - "25671:25671"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./server_certificate.crt:/etc/ssl/certs/server.crt
      - ./key.key:/etc/ssl/certs/server.key
    deploy:
      placement:
        constraints: [node.role == manager]
      restart_policy:
        condition: on-failure
```

Renaming server_certificate.pem server_key.pem to server_certificate.crt  server_key.key.

Remove keypassphrase from server_key.key to key.key:

```
openssl rsa -in server_key.key -out key.key

```
add following to nginx.conf

```yaml
...
stream {
    server {
        listen     25671 ssl;
        proxy_pass 10.192.27.111:5672;
        ssl_certificate        /etc/ssl/certs/server.crt;
        ssl_certificate_key    /etc/ssl/certs/server.key;
    }
}
```

### Java Client

#### Direction Connection

```java
public class RabbitClientTLS {

    public static void main(String[] args) throws Exception {
        char[] keyPassphrase = "stardust".toCharArray();
        KeyStore ks = KeyStore.getInstance("PKCS12");
        ks.load(new FileInputStream("D:\\2021\\Dec\\certs\\result\\client_key.p12"), keyPassphrase);

        KeyManagerFactory kmf = KeyManagerFactory.getInstance("SunX509");
        kmf.init(ks, keyPassphrase);


        char[] trustPassphrase = "stardust".toCharArray();
        KeyStore tks = KeyStore.getInstance("JKS");
        tks.load(new FileInputStream("D:\\2021\\Dec\\certs\\result\\rabbitstore"), trustPassphrase);

        TrustManagerFactory tmf = TrustManagerFactory.getInstance("SunX509");
        tmf.init(tks);

        SSLContext c = SSLContext.getInstance("TLSv1.2");
        c.init(kmf.getKeyManagers(), tmf.getTrustManagers(), null);
        ConnectionFactory factory = new ConnectionFactory();
        factory.setUsername("rabbitmq");
        factory.setPassword("rabbitpwd");

        factory.setHost("10.192.27.111");
        factory.setPort(25671);
//        factory.useSslProtocol();
        factory.useSslProtocol(c);
//        factory.enableHostnameVerification();
        Connection conn = factory.newConnection();
        Channel channel = conn.createChannel();

        channel.queueDeclare("rabbitmq-java-test", false, true, true, null);
        channel.basicPublish("", "rabbitmq-java-test", null, "Hello, World".getBytes());

        GetResponse chResponse = channel.basicGet("rabbitmq-java-test", false);
        if (chResponse == null) {
            System.out.println("No message retrieved");
        } else {
            byte[] body = chResponse.getBody();
            System.out.println("Received: " + new String(body));
        }
        channel.close();
        conn.close();
    }
}
```



####  Using spring-boot-starter-amqp

add following configurations :

```yaml
spring:
  application:
    name: ${APP_NAME:unnamed}
  # RabbitMQ??:
  rabbitmq:
    host: 10.192.27.111
    port: 5671
    username: rabbitmq
    password: rabbitpwd
#    publisher-confirms: true
    ssl:
      enabled: true
      key-store: classpath:client_key.p12
      key-store-password: stardust
      trust-store: classpath:rabbitstore
      trust-store-password: stardust
      algorithm: TLSv1.2
      key-store-type: PKCS12
      trust-store-type: JKS
      validate-server-certificate: true
      verify-hostname: false
```

For mutual verification, on client side , it needs to provide PKCS12 format keystore and JSK format truststore and set validate-server-certificate to true.

For singel side verification , set validate-server-certificate to false and provide trust-store only. 



