{"title":"Platform Logging","uid":"f0921fc9abf6ee8fdce30d6e75b79fbb","slug":"Platform-Logging","date":"2023-04-10T07:15:40.000Z","updated":"2023-04-10T07:48:00.308Z","comments":true,"path":"api/articles/Platform-Logging.json","keywords":null,"cover":"https://images.unsplash.com/photo-1571035089306-e40c9289fe78?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=687&q=80","content":"<p>For Rancher 2.6, refers this article <a href=\"\">https://zhuanlan.zhihu.com/p/481258609</a></p>\n<p>For Rancher 2.5 and 2.5 only, please refer below steps.</p>\n<h2 id=\"Abstract\"><a href=\"#Abstract\" class=\"headerlink\" title=\"Abstract\"></a>Abstract</h2><p>在 SUSE Rancher 2.5 以前，日志收集的架构是使用 Fluentd 收集指定目录日志或者容器标准输出流后，再通过 UI 日志功能页面的配置发送到指定的后端。如 Elasticsearch、splunk、kafka、syslog、fluentd 等常见的后端工具，可以自动化地收集 kubernetes 集群和运行于集群之上的工作负载日志。这种方式无疑是非常简单、易用、方便的，但是随着用户对云原生理解的加深，对业务日志分析颗粒度要求的提高，之前的日志收集方式有些太过死板，灵活性非常差，已经无法满足对日志收集具有更高要求的用户了。</p>\n<p>于是从 SUSE Rancher 2.5 版本开始，BanzaiCloud 公司的开源产品 Logging Operator 成为了新一代 SUSE Rancher 容器云平台日志采集功能的组成组件。SUSE Rancher 2.5 版本作为新日志组件的过渡版本，保留了老版本的日志收集方式，并将全新的 Logging Operator 作为实验性功能使用；SUSE Rancher 2.6 版本则已经完全使用了 Logging Operator 作为日志收集工具</p>\n<h2 id=\"Installation\"><a href=\"#Installation\" class=\"headerlink\" title=\"Installation\"></a>Installation</h2><p>从 Rancher Market Place 中安装Logging 模块， 里面包括了logging-operator， fluent/fluentbit 组件。 </p>\n<p>从Rancher Market中安装EFK（其他处理日志软件如Loki也是可以的， 取决于项目需求）。</p>\n<h2 id=\"Basic-flow\"><a href=\"#Basic-flow\" class=\"headerlink\" title=\"Basic flow\"></a>Basic flow</h2><p>Fluentbit会采集container中log里的内容，发动给fluentd。 然后fluentd会根据配置把日志发给不同的目的地。</p>\n<h2 id=\"Configuration\"><a href=\"#Configuration\" class=\"headerlink\" title=\"Configuration\"></a>Configuration</h2><p>banzai cloud 在自定义资源中主要给用户提供了两个重要的资源， flow 和 output。</p>\n<p>在Rancher 2.5中， 需要自己定义这两个资源。 clusterflow ， clusterouput与 flow, output的区别是作用域不同。</p>\n<p>ClusterOutput 内容是fluentbit的插件定义， 这里启用了elasticsearch的插件并添加了目的地等参数。</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">apiVersion: logging.banzaicloud.io&#x2F;v1beta1\nkind: ClusterOutput\nmetadata:\n  name: es-clusteroutput\nspec:\n  elasticsearch:\n    host: elasticsearch-master.efk.svc.cluster.local\n    port: 9200\n    scheme: http\n    index_name: &quot;fluentd.$&#123;tag&#125;.%Y%m%d&quot;</code></pre>\n\n<p>Clusterflow  此为fluentd的插件描述， 这边定义了获取源的select以及output的去向。 </p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">apiVersion: logging.banzaicloud.io&#x2F;v1beta1\nkind: ClusterFlow\nmetadata:\n  name: clusterflow\nspec:\n  match:\n  - select:\n      namespaces:\n      - mingxin-prod\n      - mingxin-test\n  filters:\n    - dedot:\n        de_dot_separator: &quot;-&quot;\n        de_dot_nested: true\n#    - stdout:\n#       output_type: json\n  globalOutputRefs:\n    - es-clusteroutput</code></pre>\n<p>以上资源需要在cattle-logging-system中应用。 </p>\n<h2 id=\"Post-action\"><a href=\"#Post-action\" class=\"headerlink\" title=\"Post action\"></a>Post action</h2><p>由于使用老旧版本的EFK， 7.3.0需要手动做一些工作。 </p>\n<p>在EFK接受到之后，需要在Kibana上建立index， 并且使用api建立index template。<br>PUT /_template/fluentd</p>\n<pre class=\"line-numbers language-json\" data-language=\"json\"><code class=\"language-json\">&#123;\n  &quot;index_patterns&quot;: [&quot;fluentd.*&quot;],\n  &quot;settings&quot;: &#123;\n    &quot;number_of_shards&quot;: 1\n  &#125;,\n  &quot;mappings&quot;: &#123;\n    &quot;_source&quot;: &#123;\n      &quot;enabled&quot;: true\n    &#125;,\n    &quot;properties&quot;: &#123;\n      &quot;host_name&quot;: &#123;\n        &quot;type&quot;: &quot;keyword&quot;\n      &#125;,\n      &quot;created_at&quot;: &#123;\n        &quot;type&quot;: &quot;date&quot;,\n        &quot;format&quot;: &quot;EEE MMM dd HH:mm:ss Z yyyy&quot;\n      &#125;\n    &#125;\n  &#125;\n&#125;</code></pre>\n\n\n<p>然后在Kibana上给index建立生命周期即可。</p>\n<h2 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h2><p>至此这一套基于loggin-operator的日志系统搭建完成。 </p>\n","feature":true,"text":"For Rancher 2.6, refers this article https://zhuanlan.zhihu.com/p/481258609 For Rancher 2.5 and 2.5 only, please refer below steps. Abstract...","link":"","photos":[],"count_time":{"symbolsCount":"2.6k","symbolsTime":"2 mins."},"categories":[{"name":"Configuration","slug":"Configuration","count":2,"path":"api/categories/Configuration.json"}],"tags":[{"name":"Config","slug":"Config","count":2,"path":"api/tags/Config.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Abstract\"><span class=\"toc-text\">Abstract</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Installation\"><span class=\"toc-text\">Installation</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Basic-flow\"><span class=\"toc-text\">Basic flow</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Configuration\"><span class=\"toc-text\">Configuration</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Post-action\"><span class=\"toc-text\">Post action</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Conclusion\"><span class=\"toc-text\">Conclusion</span></a></li></ol>","author":{"name":"星尘","slug":"blog-author","avatar":"https://images.unsplash.com/photo-1509114397022-ed747cca3f65?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=735&q=80","link":"/","description":"Trace on！","socials":{"github":"https://github.com/TriDiamond","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"Hello World","uid":"b9663f58f18133b35bfe243f3e916a80","slug":"hello-world","date":"2023-04-10T07:48:00.308Z","updated":"2023-04-10T07:48:00.308Z","comments":true,"path":"api/articles/hello-world.json","keywords":null,"cover":"https://images.unsplash.com/photo-1642716556212-df04701d3f97?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1976&q=80","text":"Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the ...","link":"","photos":[],"count_time":{"symbolsCount":440,"symbolsTime":"1 mins."},"categories":[{"name":"Tutorial","slug":"Tutorial","count":1,"path":"api/categories/Tutorial.json"}],"tags":[{"name":"Sample","slug":"Sample","count":1,"path":"api/tags/Sample.json"}],"author":{"name":"星尘","slug":"blog-author","avatar":"https://images.unsplash.com/photo-1509114397022-ed747cca3f65?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=735&q=80","link":"/","description":"Trace on！","socials":{"github":"https://github.com/TriDiamond","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true},"next_post":{}}